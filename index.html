<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Minecraft API - Accueil</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f4f6fa;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 520px;
      margin: 60px auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      padding: 32px 24px;
      text-align: center;
    }
    h1 { margin-bottom: 24px; color: #2d3748; }
    .desc { color: #4a5568; margin-bottom: 16px; font-size: 16px; }
    .controls { display:flex; justify-content:center; gap:10px; align-items:center; margin-bottom:20px; }
    input[type="text"] { width:280px; padding:8px; border-radius:6px; border:1px solid #cbd5e1; }
    button { padding:8px 14px; border-radius:6px; border:none; background:#3182ce; color:#fff; cursor:pointer; }
    button:disabled { background:#94b8e6; cursor:not-allowed; }
    .status {
      display:inline-flex;
      align-items:center;
      gap:8px;
      margin-left:12px;
      font-weight:600;
      color:#374151;
    }
    .dot {
      width:12px;height:12px;border-radius:50%;
      background:#e5e7eb; box-shadow:inset 0 0 0 2px rgba(0,0,0,0.03);
    }
    .dot.connected { background:#10b981; } /* green */
    .dot.error { background:#ef4444; } /* red */
    .dot.connecting { background:#f59e0b; } /* amber */
    .link-list { list-style: none; padding: 0; margin: 0; }
    .link-list li { margin: 16px 0; }
    .link-list a {
      display: inline-block; padding: 12px 32px; background: #3182ce; color: #fff;
      text-decoration: none; border-radius: 6px; font-size: 18px; transition: background 0.2s;
      box-shadow: 0 2px 8px rgba(49,130,206,0.08);
    }
    .link-list a.disabled { pointer-events:none; opacity:0.5; }
    .link-list a:hover { background: #2563eb; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Minecraft API</h1>
    <div class="desc">Saisis l'adresse WebSocket du serveur, clique sur Connect pour vérifier et sauvegarder l'IP.</div>

    <div class="controls">
      <input type="text" id="wsip" placeholder="ws://xxx.xxx.xxx.xxx:25585" />
      <button id="connectBtn">Connect</button>
      <div class="status" id="status">
        <span class="dot" id="statusDot"></span>
        <span id="statusText">Aucune connexion</span>
      </div>
    </div>

    <ul class="link-list">
      <li><a id="serverConfigLink" class="disabled" href="serverconfig.html">Configuration du serveur</a></li>
      <li><a id="gamerulesLink" class="disabled" href="gamerule2.html">Gamerules & Players</a></li>
      <li><a id="manageListsLink" class="disabled" href="manage_lists.html">Gestion OP / Allowlist / Banlist</a></li>
      <!-- autres liens -->
    </ul>
  </div>

  <script>
    const wsipInput = document.getElementById('wsip');
    const connectBtn = document.getElementById('connectBtn');
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const serverConfigLink = document.getElementById('serverConfigLink');
    const gamerulesLink = document.getElementById('gamerulesLink');
    const manageListsLink = document.getElementById('manageListsLink');

    // Utiliser indifféremment l'une des deux clés si déjà présente
    const savedIp = localStorage.getItem('wsip') || localStorage.getItem('mc_ws_url');
    if (savedIp) {
      wsipInput.value = savedIp;
      enableLinks(savedIp);
      setStatus('connected', 'IP enregistrée');
    }

    function enableLinks(ip) {
      // activer les trois liens + passer l’IP dans la query
      serverConfigLink.classList.remove('disabled');
      serverConfigLink.href = 'serverconfig.html?ws=' + encodeURIComponent(ip);

      gamerulesLink.classList.remove('disabled');
      gamerulesLink.href = 'gamerule2.html?ws=' + encodeURIComponent(ip);

      manageListsLink.classList.remove('disabled');
      manageListsLink.href = 'manage_lists.html?ws=' + encodeURIComponent(ip);
    }

    function setStatus(state, text) {
      statusDot.className = 'dot ' + (state || '');
      statusText.textContent = text || '';
    }

    // Clicks sur les liens : s’assurer que l’IP est présente + mise à jour query/hyperliens
    serverConfigLink.addEventListener('click', (e) => {
      const ip = wsipInput.value.trim();
      if (!ip) {
        e.preventDefault();
        alert('Entrez une IP WebSocket avant d\'ouvrir la page.');
        return;
      }
      persistIp(ip);
      serverConfigLink.href = 'serverconfig.html?ws=' + encodeURIComponent(ip);
    });

    gamerulesLink.addEventListener('click', (e) => {
      const ip = wsipInput.value.trim();
      if (!ip) {
        e.preventDefault();
        alert('Entrez une IP WebSocket avant d\'ouvrir la page.');
        return;
      }
      persistIp(ip);
      gamerulesLink.href = 'gamerule2.html?ws=' + encodeURIComponent(ip);
      manageListsLink.href = 'manage_lists.html?ws=' + encodeURIComponent(ip);
      serverConfigLink.href = 'serverconfig.html?ws=' + encodeURIComponent(ip);
    });

    manageListsLink.addEventListener('click', (e) => {
      const ip = wsipInput.value.trim();
      if (!ip) {
        e.preventDefault();
        alert('Entrez une IP WebSocket avant d\'ouvrir la page.');
        return;
      }
      persistIp(ip);
      manageListsLink.href = 'manage_lists.html?ws=' + encodeURIComponent(ip);
      gamerulesLink.href = 'gamerule2.html?ws=' + encodeURIComponent(ip);
      serverConfigLink.href = 'serverconfig.html?ws=' + encodeURIComponent(ip);
    });

    function persistIp(ip) {
      // on enregistre dans les DEUX clés pour compatibilité avec toutes les pages
      localStorage.setItem('wsip', ip);
      localStorage.setItem('mc_ws_url', ip);
      enableLinks(ip);
    }

    connectBtn.addEventListener('click', () => {
      const ip = wsipInput.value.trim();
      if (!ip) return alert('Entrez une IP WebSocket !');

      setStatus('connecting', 'Connexion en cours...');
      connectBtn.disabled = true;

      // test rapide de connexion : on ouvre, si ok on sauvegarde, puis on ferme
      let testWs;
      try {
        testWs = new WebSocket(ip);
      } catch (e) {
        setStatus('error', 'URL invalide');
        connectBtn.disabled = false;
        return;
      }

      const timeout = setTimeout(() => {
        if (testWs && testWs.readyState !== WebSocket.OPEN) {
          try { testWs.close(); } catch(e){}
          setStatus('error', 'Temps écoulé');
          connectBtn.disabled = false;
        }
      }, 4000);

      testWs.onopen = () => {
        clearTimeout(timeout);
        persistIp(ip); // <-- enregistre wsip + mc_ws_url
        setStatus('connected', '✅ IP validée et sauvegardée');
        setTimeout(() => {
          try { testWs.close(); } catch(e){}
          connectBtn.disabled = false;
        }, 600);
      };

      testWs.onerror = () => {
        clearTimeout(timeout);
        setStatus('error', '❌ Erreur de connexion');
        connectBtn.disabled = false;
        try { testWs.close(); } catch(e){}
      };

      testWs.onclose = () => {
        // si on a déjà validé, on laisse l'état connecté
      };
    });
  </script>
</body>
</html>
